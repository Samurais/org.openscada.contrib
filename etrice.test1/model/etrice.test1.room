RoomModel etrice.test1 {

	import room.basic.service.timing.* from "../../org.eclipse.etrice.modellib.java/models/TimingService.room"
	import room.basic.types.* from "../../org.eclipse.etrice.modellib.java/models/Types.room"
	import org.openscada.etrice.* from "../../org.openscada.etrice/model/org.openscada.etrice.room"

	LogicalSystem Test_LogSystem {
		
		SubSystemRef subsystem : Test_SubSystem
		
	}

	SubSystemClass Test_SubSystem {
		ActorRef top : TestTop
		ActorRef timer: ATimingService
		
		ActorRef item : ServerDataItem
		 
		LayerConnection ref top satisfied_by timer.timer
		// LayerConnection ref top satisfied_by item.server
	}
	
	ActorClass Item1 extends ServerDataItem {
		Structure { }
		Behavior { }
	}
	ActorClass Item2 extends ServerDataItem {
		Structure { }
		Behavior { }
	}
	
	ActorClass TestTop {
		Structure {
			SAP timer : PTimer
			ActorRef test : Test
			ActorRef serverItem1: Item1
			ActorRef serverItem2: Item2
			Binding serverItem1.server and test.item1
			Binding serverItem2.server and test.item2
		}
		Behavior { }
	}
	
	ActorClass Test {
		Interface {
			 conjugated Port item1: ServerItemProtocol
			 conjugated Port item2: ServerItemProtocol
		}
		Structure {
			external Port item1
			external Port item2
			
			SAP timer : PTimer
			Attribute counter : int32
		}
		Behavior{
			StateMachine {
				Transition init: initial -> state0 { }
				Transition tr0: state0 -> state1 {
					triggers {
						<timeout: timer>
					}
				}
				Transition tr1: state1 -> state1 {
					triggers {
						<timeout: timer>
					}
				}
				Transition reset: state1 -> state1 {
					triggers {
						<writeCall: item1>
					}
					action {
						"counter=0;"
					}
				}
				State state0 {
					entry {
						"item1.register(\"item1\");\nitem2.register(\"item2\");\n\nitem1.update(\"1\");\nitem2.update(\"1\");\n\ntimer.startTimer(1000);\n\n\n"
					}
				}
				State state1
				{
					entry {
						"System.out.println(\"Hello World\");\n\ncounter++;\nitem1.update(\"\"+counter);\nitem2.update(\"\"+counter);\n\ntimer.startTimer(1000);\n\n"
					}
				}
			}
		}
	}
	

}